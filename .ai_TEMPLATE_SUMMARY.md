# .ai 文件夹使用指南 - 项目知识库系统

## 📌 概述

`.ai` 文件夹是一个 **项目知识库系统**，用于记录项目信息、问题、解决方案、关键代码位置等。它帮助 AI 助手（和人类开发者）快速理解项目并避免重复错误。

## 🎯 核心目的

1. **知识积累** - 记录项目演进过程中遇到的所有问题和解决方案
2. **快速上手** - 新对话时快速了解项目结构和背景
3. **错误预防** - 避免重复犯同样的错误
4. **最佳实践** - 保存关键代码位置和常用命令

## 📁 文件结构

```
.ai/
├── README.md                      # 系统说明（本体）
├── MUST_READ_FIRST.md            # 强制规则和快速检查清单
├── PROJECT_OVERVIEW.md      # 项目基本信息和架构
├── IMPORTANT_NOTES.md          # 关键代码位置、常用命令、常见错误
├── ISSUES_AND_SOLUTIONS.md       # 所有遇到的问题和解决方案
├── COMPLIANCE_GUIDE.md           # 合规性指南（可选）
└── .INIT_REQUIRED             # 初始化完成标记（可选）
```

## 📖 每个文件的职责

### 1. **README.md** - 系统说明
- 用途：解释.ai文件夹的目的和使用规则
- 内容：
  - 各文件的用途和何时使用
  - 使用规则（对AI和用户）
  - 文档维护规范
  - 标记规范（✅ ❌ ⚠️ 等）

### 2. **MUST_READ_FIRST.md** - 强制规则⚠️
- 用途：AI 助手每次新对话必读
- 内容：
  - 协议约定（强制规则）
  - 新对话、修改代码、结束对话时的强制步骤
  - 项目关键信息速查表
  - 常见错误预防清单
  - 快速检查清单

### 3. **PROJECT_OVERVIEW.md** - 项目概览
- 用途：快速了解项目结构和信息
- 内容：
  - 项目基本信息（名称、版本、语言、License）
  - 项目描述和核心特性
  - 详细的目录结构说明
  - 主要依赖关系
  - 重要配置文件
  - 前端/主题信息

### 4. **IMPORTANT_NOTES.md** - 关键信息🔧
- 用途：快速查找关键代码位置和常见问题
- 内容：
  - 关键代码位置（module、配置、关键类/函数等）
  - 常用命令（快速参考）
  - 文件修改检查清单（修改前必读）
  - 常见错误和解决方案
  - 安全操作方式

### 5. **ISSUES_AND_SOLUTIONS.md** - 问题库📋
- 用途：记录所有遇到的问题和解决方案
- 内容：
  - 问题描述
  - 根本原因分析
  - 采用的解决方案（✅ 成功的）
  - 失败的尝试（❌ 标记）
  - 关键提交/代码位置
  - 经验教训和启示

## 🔄 工作流程

### 📍 新对话开始时（MUST）

```
1. 读取 .ai/MUST_READ_FIRST.md
   ↓
2. 读取 .ai/PROJECT_OVERVIEW.md
   ↓
3. 读取 .ai/IMPORTANT_NOTES.md
   ↓
4. 读取 .ai/ISSUES_AND_SOLUTIONS.md
   ↓
5. 开始工作
```

### 🔨 修改代码时（MUST）

```
代码修改 → 修改完成
   ↓
更新 .ai/ISSUES_AND_SOLUTIONS.md
   ↓
如有新发现，更新 .ai/IMPORTANT_NOTES.md
   ↓
git add .ai/
git commit "修改内容 + .ai 文档更新"
```

### ✅ 结束对话前（MUST）

```
代码修改 ✓
   ↓
.ai/ISSUES_AND_SOLUTIONS.md 更新 ✓
   ↓
.ai/IMPORTANT_NOTES.md 更新 ✓
   ↓
.ai/ 文件已 commit ✓
   ↓
准备完成！
```

## 📝 标记规范

在记录内容时使用以下标记：

| 标记 | 用途 | 示例 |
|------|------|------|
| `✅` | 成功的解决方案 | ✅ 使用url.JoinPath()分离编码逻辑 |
| `❌` | 失败的尝试或已撤销的方案 | ❌ 直接在OSS Key中编码（导致访问失败） |
| `⚠️` | 需要注意的地方 | ⚠️ 修改go.mod时要同步更新import |
| `📋` | 信息记录 | 📋 当前版本v1.1.5 |

## 🎓 内容编写指南

### ISSUES_AND_SOLUTIONS.md 的结构

```markdown
## 问题名称

**发现时间**: 2026-02-10
**状态**: ✅ 已解决

### 问题描述
[具体描述问题现象]

### 根本原因分析
[分析为什么会出现这个问题]

### 解决方案
[详细说明采取的解决方案]

### 关键修改
- [文件路径] - [简要说明改动]
- [提交hash或链接]

### 失败尝试（供参考）
- ❌ [尝试过但不行的方法]
- ❌ [另一个不行的方法]

### 经验教训
[从这个问题中学到了什么，如何预防类似问题]
```

### IMPORTANT_NOTES.md 的结构

```markdown
## 关键代码位置

### [功能分类]
- **[文件路径]**: [简要说明功能]
- **[另一个位置]**: [说明]

## 常用命令

### [命令分类]
```bash
[完整命令示例]
# [说明]
```

## 常见错误和解决

### [错误名称]
**症状**: [现象]
**原因**: [根本原因]
**解决**: [解决步骤]
```

## 🚀 在新项目上使用

### 第一步：创建文件夹
```bash
mkdir -p .ai
```

### 第二步：创建初始文件

根据项目类型创建对应的文件：

```bash
# 所有项目都需要
touch .ai/README.md
touch .ai/MUST_READ_FIRST.md
touch .ai/PROJECT_OVERVIEW.md
touch .ai/IMPORTANT_NOTES.md
touch .ai/ISSUES_AND_SOLUTIONS.md
```

### 第三步：填充内容

参考本项目（Sonic）的.ai文件作为模板，根据你的项目修改：

1. **README.md** - 直接复制，这个文件是通用的
2. **MUST_READ_FIRST.md** - 更改项目名称和关键信息表
3. **PROJECT_OVERVIEW.md** - 根据项目结构重写
4. **IMPORTANT_NOTES.md** - 添加项目特定的关键位置和常见错误
5. **ISSUES_AND_SOLUTIONS.md** - 从空文件开始，逐步填充

### 第四步：配置 Git

```bash
# 确保.ai文件夹被跟踪
git add .ai/
git commit "chore: add AI knowledge base system"

# 可选：添加到.gitignore（仅保留模板，不跟踪生成内容）
# 或不添加（推荐），完全跟踪所有知识
```

## 💡 最佳实践

### ✅ 应该做的事

1. **定期更新** - 每次修改代码都更新.ai/
2. **详细记录** - 包括问题、原因、解决方案、学到的东西
3. **及时标记** - 使用✅❌⚠️清晰标记内容状态
4. **保持文档最新** - 定期检查是否需要更新时间戳
5. **分享知识** - 在ISSUES_AND_SOLUTIONS.md中详细记录教训

### ❌ 不要做的事

1. **修改代码但不更新.ai/** - 违反强制规则
2. **提交不包含.ai/的更改** - 知识库会过期
3. **删除或覆盖.ai/内容** - 会丢失宝贵的知识
4. **记录错误信息** - 只记录验证过的正确解决方案
5. **忽视.ai文件的更新** - 导致AI和人类开发者做重复工作

## 📊 维护时间投入

一个中等规模的问题记录通常需要：
- 简单问题：2-3 分钟
- 复杂问题：5-10 分钟
- 关键代码位置记录：1-2 分钟

**总体而言，维护.ai文件的时间投入远小于后续重复错误的成本！**

## 🔗 与其他工具的集成

### Git 钩子（强烈推荐）

项目包含两个脚本来强化 `.ai/` 更新规则：

#### 1. **install-git-hooks.sh** - Pre-commit 钩子
安装位置：`scripts/install-git-hooks.sh`

**功能**：
- 监控代码修改（.go、.yaml、.js 等文件）
- 检查是否更新了 `.ai/` 文件
- 如果代码改动但未更新 `.ai/`，**警告并要求确认**
- 防止删除关键的 `.ai/` 文件（`.INIT_REQUIRED`、`MUST_READ_FIRST.md`）

**安装方式**：
```bash
bash scripts/install-git-hooks.sh
```

**工作流程**：
```
git commit → 触发 pre-commit 钩子
    ↓
检查是否有代码文件被提交
    ↓
检查是否有 .ai/ 文件被提交
    ↓
如果代码有改动但 .ai/ 无改动 → 警告用户
    ↓
用户可以选择：
  - 'y' 继续提交（风险操作）
  - 'N' 取消提交（推荐，先更新.ai/)
```

**示例输出**：
```
⚠️  WARNING: Code modified but .ai/ knowledge base not updated!

Code files being committed:
  ✗ service/storage/impl/url_file_descriptor.go
  ✗ handler/admin/attachment.go

Missing .ai/ updates! According to project rules:
  • Update .ai/ISSUES_AND_SOLUTIONS.md
  • Update .ai/IMPORTANT_NOTES.md (if needed)
  • Stage changes: git add .ai/

Proceed without .ai/ updates? (y/N)
```
#### 2. **check-ai-init.sh** - 初始化检查脚本
安装位置：`scripts/check-ai-init.sh`

**功能**：
- 验证所有必须的 `.ai/` 文件都存在
- 检查文件内容不为空
- 作为项目初始化检查

**使用方式**：
```bash
bash scripts/check-ai-init.sh
```

**检查内容**：
```
✓ .ai/.INIT_REQUIRED
✓ .ai/MUST_READ_FIRST.md
✓ .ai/PROJECT_OVERVIEW.md
✓ .ai/IMPORTANT_NOTES.md
✓ .ai/ISSUES_AND_SOLUTIONS.md
```

**在 CI/CD 中使用**：
```yaml
# .github/workflows/ci.yml 或类似
- name: Check AI Knowledge Base
  run: bash scripts/check-ai-init.sh
```

#### 3. **.INIT_REQUIRED** 初始化标记文件
作用：
- 标记项目已初始化 `.ai/` 系统
- pre-commit 钩子会保护这个文件，防止被删除
- 防止知识库被意外清除

创建方式：
```bash
touch .ai/.INIT_REQUIRED
```

### Pre-commit Hook 详细说明

```bash
#!/bin/bash
# Pre-commit hook: Enforce .ai/ knowledge base updates

set -e

# 获取将被提交的文件
STAGED_FILES=$(git diff --cached --name-only)

# 分离代码文件和 .ai/ 文件
CODE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(go|yaml|yml|mod|sum)$')
AI_FILES=$(echo "$STAGED_FILES" | grep '^\.ai/')

# 如果有代码改动但没有 .ai/ 改动，发出警告
if [ -n "$CODE_FILES" ] && [ -z "$AI_FILES" ]; then
    # 警告用户并询问
    # 用户需要显式同意（y）才能跳过
fi

# 防止删除关键文件
if git diff --cached --diff-filter=D | grep '\.ai/.INIT_REQUIRED'; then
    echo "ERROR: Cannot delete .ai/.INIT_REQUIRED!"
    exit 1
fi
```

**支持的代码文件类型**：
- Go: `.go`
- 配置: `.yaml`, `.yml`, `.mod`, `.sum`
- 其他: `.java`, `.py`, `.ts`, `.js`

### CI/CD 检查（可选）

可以在 GitHub Actions 中添加检查，在每个 PR 或 push 时验证 `.ai/` 文件：

```yaml
# .github/workflows/ai-compliance.yml
name: AI Knowledge Base Compliance

on: [pull_request, push]

jobs:
  check-ai:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check AI Knowledge Base
    run: bash scripts/check-ai-init.sh
      
      - name: Verify .ai updates
        run: |
          # 如果有代码改动，检查是否更新了 .ai/
          CHANGED_CODE=$(git diff origin/master --name-only | grep -E '\.(go|yaml|yml|mod)$' || true)
          CHANGED_AI=$(git diff origin/master --name-only | grep '^\.ai/' || true)
          
          if [ -n "$CHANGED_CODE" ] && [ -z "$CHANGED_AI" ]; then
            echo "⚠️ Warning: Code changed but .ai/ not updated"
            exit 0  # 警告但不失败（可改为 exit 1 强制）
          fi
```

**快速部署 Git 钩子**：
```bash
# 方式 1：手动运行脚本（推荐在项目初始化时）
bash scripts/install-git-hooks.sh

# 方式 2：在 package.json 中添加（如果是 Node.js 项目）
{
  "scripts": {
    "setup": "bash scripts/install-git-hooks.sh"
  }
}

# 方式 3：在 Makefile 中添加（如果是 Go 项目）
.PHONY: setup-hooks
setup-hooks:
	bash scripts/install-git-hooks.sh
```

**卸载 Git 钩子**：
```bash
rm .git/hooks/pre-commit
```

## 📚 参考案例

项目 **Sonic**（Go 博客平台）的.ai文件夹包含：
- 项目架构和模块说明
- Docker 构建和版本发布流程
- 中文文件名编码问题的完整解决方案
- 常见 Go 编译和 GitHub Actions 错误
- 安全的代码修改操作指南

## 🎯 总结

`.ai` 文件夹是一个 **简单但强大的系统**：

✅ **好处**:
- 减少重复错误
- 加快问题解决速度
- 帮助 AI 更好地理解项目
- 建立项目知识库
- 提高团队效率

⏱️ **投入**:
- 初始设置：15-30 分钟
- 每次维护：2-10 分钟
- 长期收益：**节省数小时到数天的重复工作**

---

**推荐**：在任何需要长期维护的项目上使用这个系统！

