# Git 钩子模板 - 适用于其他项目

这个文档提供了可以直接复制到其他项目的 git 钩子脚本。

## 快速部署

### 方式 1：直接使用现成脚本

如果你的项目 Go 项目或需要完全相同的功能，直接复制：

```bash
# 复制脚本文件
cp scripts/install-git-hooks.sh /your-project/scripts/
cp scripts/check-ai-init.sh /your-project/scripts/

# 安装钩子
cd /your-project
bash scripts/install-git-hooks.sh
```

### 方式 2：手动创建钩子（自定义版本）

#### 第一步：创建钩子文件

```bash
mkdir -p .git/hooks
cat > .git/hooks/pre-commit << 'EOF'
#!/bin/bash
# Pre-commit hook: Enforce .ai/ knowledge base updates

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get staged files
STAGED_FILES=$(git diff --cached --name-only)

# Separate code files from .ai files
CODE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(go|yaml|yml|mod|sum|java|py|ts|js)$' || true)
AI_FILES=$(echo "$STAGED_FILES" | grep '^\.ai/' || true)

# If code is modified but .ai/ is not, warn user
if [ -n "$CODE_FILES" ] && [ -z "$AI_FILES" ]; then
    echo -e "${RED}⚠️  WARNING: Code modified but .ai/ knowledge base not updated!${NC}"
    echo ""
    echo "Code files being committed:"
    echo "$CODE_FILES" | sed 's/^/  ✗ /'
    echo ""
    echo "Missing .ai/ updates! According to project rules:"
    echo "  • Update .ai/ISSUES_AND_SOLUTIONS.md"
    echo "  • Update .ai/IMPORTANT_NOTES.md (if needed)"
    echo "  • Stage changes: git add .ai/"
    echo ""
    echo -e "${YELLOW}Proceed without .ai/ updates? (y/N)${NC}"
    read -r response
    
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        echo -e "${RED}Commit cancelled. Please update .ai/ files first.${NC}"
        exit 1
    fi
fi

# Prevent deletion of critical .ai/ files
if git diff --cached --diff-filter=D --name-only | grep -q '\.ai/\.INIT_REQUIRED'; then
    echo -e "${RED}❌ ERROR: Cannot delete .ai/.INIT_REQUIRED!${NC}"
    echo "This file is mandatory for AI initialization."
    exit 1
fi

if git diff --cached --diff-filter=D --name-only | grep -q '\.ai/MUST_READ_FIRST.md'; then
    echo -e "${RED}❌ ERROR: Cannot delete .ai/MUST_READ_FIRST.md!${NC}"
    echo "This file documents critical project conventions."
    exit 1
fi

echo -e "${GREEN}✓ Pre-commit check passed${NC}"
exit 0
EOF

chmod +x .git/hooks/pre-commit
```

#### 第二步：创建初始化检查脚本

```bash
cat > scripts/check-ai-init.sh << 'EOF'
#!/bin/bash
# AI Initialization Compliance Check

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}╔════════════════════════╗${NC}"
echo -e "${BLUE}║  AI Knowledge Base Compliance  ║${NC}"
echo -e "${BLUE}╚══════════════╝${NC}"
echo ""

# Check if .ai/ folder exists
if [ ! -d ".ai" ]; then
    echo -e "${RED}❌ ERROR: .ai/ folder not found!${NC}"
    echo "This project requires the .ai/ knowledge base folder."
    exit 1
fi

# Check critical files
FILES=(
    ".ai/.INIT_REQUIRED"
    ".ai/MUST_READ_FIRST.md"
    ".ai/PROJECT_OVERVIEW.md"
    ".ai/IMPORTANT_NOTES.md"
    ".ai/ISSUES_AND_SOLUTIONS.md"
)

MISSING_FILES=()

echo "Checking required .ai/ files..."
for file in "${FILES[@]}"; do
    if [ -f "$file" ]; then
        echo -e "  ${GREEN}✓${NC} $file"
    else
        echo -e "  ${RED}✗${NC} $file (MISSING)"
        MISSING_FILES+=("$file")
    fi
done

echo ""

if [ ${#MISSING_FILES[@]} -gt 0 ]; then
    echo -e "${RED}❌ ERROR: Missing critical files:${NC}"
    for file in "${MISSING_FILES[@]}"; do
      echo "  - $file"
    done
    exit 1
fi

# Verify all files are not empty
echo ""
echo "Verifying file contents..."
EMPTY_FILES=()

for file in "${FILES[@]}"; do
    if [ -s "$file" ]; then
        SIZE=$(wc -c < "$file")
        echo -e "  ${GREEN}✓${NC} $file ($SIZE bytes)"
    else
        echo -e "  ${RED}✗${NC} $file (EMPTY)"
        EMPTY_FILES+=("$file")
    fi
done

if [ ${#EMPTY_FILES[@]} -gt 0 ]; then
    echo -e "${YELLOW}⚠️  WARNING: Some files are empty:${NC}"
    for file in "${EMPTY_FILES[@]}"; do
        echo "  - $file"
    done
fi

echo ""
echo -e "${BLUE}══════════════${NC}"
echo -e "${GREEN}✅ AI Knowledge Base Check Passed!${NC}"
echo ""
echo "For AI Assistants - You MUST read these files in order:"
echo "  1. .ai/.INIT_REQUIRED (this file marks initialization requirement)"
echo "  2. .ai/MUST_READ_FIRST.md (behavioral rules)"
echo "  3. .ai/PROJECT_OVERVIEW.md (project structure)"
echo "  4. .ai/IMPORTANT_NOTES.md (critical information)"
echo "  5. .ai/ISSUES_AND_SOLUTIONS.md (known problems and solutions)"
echo ""
echo "After reading all files, you are ready to work on this project."
echo -e "${BLUE}══════════════════════════${NC}"

exit 0
EOF

chmod +x scripts/check-ai-init.sh
```

#### 第三步：创建初始化标记文件

```bash
touch .ai/.INIT_REQUIRED
```

#### 第四步：配置 Git

```bash
git add .ai/.INIT_REQUIRED scripts/check-ai-init.sh
git commit "chore: add AI knowledge base system with git hooks"
```

## 定制化选项

### 修改支持的文件类型

在 pre-commit 钩子中修改这一行：

```bash
# 默认
CODE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(go|yaml|yml|mod|sum|java|py|ts|js)$' || true)

# Node.js 项目（添加 .json 文件）
CODE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|ts|json|jsx|tsx|yaml|yml)$' || true)
# Python 项目（添加 .py 文件）
CODE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(py|yaml|yml|toml|txt)$' || true)

# Rust 项目（添加 .rs 文件）
CODE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(rs|toml|yaml|yml)$' || true)
```

### 修改警告为强制

如果想让 pre-commit 钩子强制更新 `.ai/`，不允许跳过：

```bash
if [ -n "$CODE_FILES" ] && [ -z "$AI_FILES" ]; then
    echo -e "${RED}❌ ERROR: Code modified but .ai/ knowledge base not updated!${NC}"
    echo "Commit cancelled. Please update .ai/ files first."
    exit 1  # 这里改为 exit 1（原来是询问用户）
fi
```

### 添加更多文件类型保护

```bash
# 防止删除其他关键文件
CRITICAL_FILES=(
    ".ai/.INIT_REQUIRED"
    ".ai/MUST_READ_FIRST.md"
    ".ai/PROJECT_OVERVIEW.md"
    ".ai/IMPORTANT_NOTES.md"
    ".ai/ISSUES_AND_SOLUTIONS.md"
)

for critical_file in "${CRITICAL_FILES[@]}"; do
    if git diff --cached --diff-filter=D --name-only | grep -q "$critical_file"; then
      echo -e "${RED}❌ ERROR: Cannot delete $critical_file!${NC}"
        echo "This file is critical for the project."
        exit 1
    fi
done
```

## 在不同项目类型中使用

### Node.js / TypeScript 项目

```json
{
  "scripts": {
    "prepare": "bash scripts/install-git-hooks.sh",
    "setup": "npm install && bash scripts/install-git-hooks.sh"
  }
}
```

运行：
```bash
npm run setup
```

### Python 项目

```toml
# pyproject.toml
[tool.poetry.scripts]
setup-hooks = "bash scripts/install-git-hooks.sh"
```

或在 `Makefile` 中：
```makefile
.PHONY: setup
setup: 
	pip install -r requirements.txt
	bash scripts/install-git-hooks.sh
```

### Go 项目

```makefile
# Makefile
.PHONY: setup
setup:
	go mod download
	bash scripts/install-git-hooks.sh

.PHONY: check-ai
check-ai:
	bash scripts/check-ai-init.sh
```

## 故障排除

### 钩子不工作？

```bash
# 检查权限
ls -la .git/hooks/pre-commit
# 应该有 +x 权限

# 修复权限
chmod +x .git/hooks/pre-commit

# 手动测试
bash .git/hooks/pre-commit
```

### 需要跳过钩子？

```bash
# 临时跳过钩子（紧急情况）
git commit --no-verify -m "Emergency commit"

# ⚠️ 但之后必须更新 .ai/ 文件！
git add .ai/
git commit "chore: update AI knowledge base"
```

### 卸载钩子？

```bash
rm .git/hooks/pre-commit

# 或者从 git ignore 中忽略钩子
echo ".git/hooks/pre-commit" >> .gitignore
```

## 完整快速开始命令

```bash
# 1. 创建必要的目录和文件
mkdir -p scripts .ai
touch .ai/.INIT_REQUIRED

# 2. 创建 pre-commit 钩子（见上面的完整脚本）
mkdir -p .git/hooks
# 粘贴 pre-commit 脚本内容

# 3. 创建初始化检查脚本（见上面的完整脚本）
# 粘贴 check-ai-init.sh 内容

# 4. 设置权限
chmod +x .git/hooks/pre-commit scripts/check-ai-init.sh

# 5. 测试
bash scripts/check-ai-init.sh

# 6. 提交
git add .ai/.INIT_REQUIRED scripts/check-ai-init.sh .git/hooks/pre-commit
git commit "chore: add AI knowledge base system with git hooks"
```

## 集成到 CI/CD

### GitHub Actions

```yaml
# .github/workflows/ai-check.yml
name: AI Knowledge Base Check

on: [push, pull_request]

jobs:
  check-ai:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check AI Knowledge Base
        run: bash scripts/check-ai-init.sh
```

### GitLab CI

```yaml
# .gitlab-ci.yml
ai_check:
  script:
    - bash scripts/check-ai-init.sh
  only:
    - merge_requests
    - main
```

### Pre-push 钩子（可选）

如果想在 push 前也检查，创建 `.git/hooks/pre-push`：

```bash
#!/bin/bash
# Pre-push hook: Verify AI knowledge base

bash scripts/check-ai-init.sh || {
    echo "❌ AI knowledge base check failed. Cannot push."
    exit 1
}

exit 0
```

## 总结

✅ **三种部署方式**：
1. 自动化：`bash scripts/install-git-hooks.sh`
2. 半自动：通过 package.json / Makefile
3. 手动：直接创建文件和脚本

✅ **完全可定制**：
- 修改支持的文件类型
- 修改警告策略（警告 vs 强制）
- 添加其他保护规则

✅ **零依赖**：
- 只用 bash 和标准 Linux 工具
- 不需要任何包管理器或外部依赖
- 可在任何项目上使用

